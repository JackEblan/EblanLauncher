/*
 *
 *   Copyright 2023 Einstein Blanco
 *
 *   Licensed under the GNU General Public License v3.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *
 *       https://www.gnu.org/licenses/gpl-3.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 *
 */
package com.eblan.launcher.feature.home

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.eblan.launcher.domain.framework.AppWidgetHostWrapper
import com.eblan.launcher.domain.framework.FileManager
import com.eblan.launcher.domain.framework.LauncherAppsWrapper
import com.eblan.launcher.domain.framework.PackageManagerWrapper
import com.eblan.launcher.domain.model.AppDrawerSettings
import com.eblan.launcher.domain.model.Associate
import com.eblan.launcher.domain.model.EblanApplicationInfo
import com.eblan.launcher.domain.model.FolderDataById
import com.eblan.launcher.domain.model.GetEblanApplicationInfosByLabel
import com.eblan.launcher.domain.model.GridItem
import com.eblan.launcher.domain.model.GridItemCache
import com.eblan.launcher.domain.model.GridItemData
import com.eblan.launcher.domain.model.GridItemData.ShortcutInfo
import com.eblan.launcher.domain.model.LauncherAppsEvent
import com.eblan.launcher.domain.model.MoveGridItemResult
import com.eblan.launcher.domain.model.PageItem
import com.eblan.launcher.domain.model.PinItemRequestType
import com.eblan.launcher.domain.repository.EblanAppWidgetProviderInfoRepository
import com.eblan.launcher.domain.repository.EblanApplicationInfoRepository
import com.eblan.launcher.domain.repository.EblanApplicationInfoTagRepository
import com.eblan.launcher.domain.repository.FolderGridCacheRepository
import com.eblan.launcher.domain.repository.GridCacheRepository
import com.eblan.launcher.domain.repository.GridRepository
import com.eblan.launcher.domain.repository.UserDataRepository
import com.eblan.launcher.domain.usecase.GetHomeDataUseCase
import com.eblan.launcher.domain.usecase.application.GetEblanAppWidgetProviderInfosByLabelUseCase
import com.eblan.launcher.domain.usecase.application.GetEblanApplicationInfosByLabelUseCase
import com.eblan.launcher.domain.usecase.application.GetEblanShortcutConfigsByLabelUseCase
import com.eblan.launcher.domain.usecase.application.GetEblanShortcutInfosUseCase
import com.eblan.launcher.domain.usecase.grid.GetFolderDataByIdUseCase
import com.eblan.launcher.domain.usecase.grid.GetGridItemsCacheUseCase
import com.eblan.launcher.domain.usecase.grid.MoveFolderGridItemUseCase
import com.eblan.launcher.domain.usecase.grid.MoveGridItemOutsideFolderUseCase
import com.eblan.launcher.domain.usecase.grid.MoveGridItemUseCase
import com.eblan.launcher.domain.usecase.grid.ResizeFolderGridItemUseCase
import com.eblan.launcher.domain.usecase.grid.ResizeGridItemUseCase
import com.eblan.launcher.domain.usecase.grid.UpdateFolderGridItemsAfterResizeUseCase
import com.eblan.launcher.domain.usecase.grid.UpdateGridItemsAfterMoveUseCase
import com.eblan.launcher.domain.usecase.grid.UpdateGridItemsAfterResizeUseCase
import com.eblan.launcher.domain.usecase.iconpack.GetIconPackFilePathsUseCase
import com.eblan.launcher.domain.usecase.launcherapps.AddPackageUseCase
import com.eblan.launcher.domain.usecase.launcherapps.ChangePackageUseCase
import com.eblan.launcher.domain.usecase.launcherapps.ChangeShortcutsUseCase
import com.eblan.launcher.domain.usecase.launcherapps.RemovePackageUseCase
import com.eblan.launcher.domain.usecase.launcherapps.SyncDataUseCase
import com.eblan.launcher.domain.usecase.page.CachePageItemsUseCase
import com.eblan.launcher.domain.usecase.page.UpdatePageItemsUseCase
import com.eblan.launcher.domain.usecase.pin.GetPinGridItemUseCase
import com.eblan.launcher.feature.home.model.HomeUiState
import com.eblan.launcher.feature.home.model.Screen
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.Job
import kotlinx.coroutines.cancelAndJoin
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import java.io.File
import javax.inject.Inject

@HiltViewModel
internal class HomeViewModel @Inject constructor(
    getHomeDataUseCase: GetHomeDataUseCase,
    private val gridCacheRepository: GridCacheRepository,
    private val folderGridCacheRepository: FolderGridCacheRepository,
    private val moveGridItemUseCase: MoveGridItemUseCase,
    private val resizeGridItemUseCase: ResizeGridItemUseCase,
    private val cachePageItemsUseCase: CachePageItemsUseCase,
    private val updatePageItemsUseCase: UpdatePageItemsUseCase,
    private val appWidgetHostWrapper: AppWidgetHostWrapper,
    private val updateGridItemsAfterResizeUseCase: UpdateGridItemsAfterResizeUseCase,
    private val updateGridItemsAfterMoveUseCase: UpdateGridItemsAfterMoveUseCase,
    private val moveFolderGridItemUseCase: MoveFolderGridItemUseCase,
    private val getFolderDataByIdUseCase: GetFolderDataByIdUseCase,
    getGridItemsCacheUseCase: GetGridItemsCacheUseCase,
    private val getPinGridItemUseCase: GetPinGridItemUseCase,
    private val fileManager: FileManager,
    private val packageManagerWrapper: PackageManagerWrapper,
    getEblanShortcutInfosUseCase: GetEblanShortcutInfosUseCase,
    eblanAppWidgetProviderInfoRepository: EblanAppWidgetProviderInfoRepository,
    getIconPackFilePathsUseCase: GetIconPackFilePathsUseCase,
    private val moveGridItemOutsideFolderUseCase: MoveGridItemOutsideFolderUseCase,
    getEblanApplicationInfosByLabelUseCase: GetEblanApplicationInfosByLabelUseCase,
    getEblanAppWidgetProviderInfosByLabelUseCase: GetEblanAppWidgetProviderInfosByLabelUseCase,
    getEblanShortcutConfigsByLabelUseCase: GetEblanShortcutConfigsByLabelUseCase,
    private val gridRepository: GridRepository,
    eblanApplicationInfoTagRepository: EblanApplicationInfoTagRepository,
    private val syncDataUseCase: SyncDataUseCase,
    private val launcherAppsWrapper: LauncherAppsWrapper,
    private val addPackageUseCase: AddPackageUseCase,
    private val removePackageUseCase: RemovePackageUseCase,
    private val changePackageUseCase: ChangePackageUseCase,
    private val changeShortcutsUseCase: ChangeShortcutsUseCase,
    private val resizeFolderGridItemUseCase: ResizeFolderGridItemUseCase,
    private val updateFolderGridItemsAfterResizeUseCase: UpdateFolderGridItemsAfterResizeUseCase,
    private val userDataRepository: UserDataRepository,
    private val eblanApplicationInfoRepository: EblanApplicationInfoRepository,
) : ViewModel() {
    val homeUiState = getHomeDataUseCase().map(HomeUiState::Success).stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5_000),
        initialValue = HomeUiState.Loading,
    )

    private val _screen = MutableStateFlow<Screen>(Screen.Pager)

    val screen = _screen.asStateFlow()

    private val _moveGridItemResult = MutableStateFlow<MoveGridItemResult?>(null)

    val movedGridItemResult = _moveGridItemResult.asStateFlow()

    private val defaultDelay = 500L

    private val _pageItems = MutableStateFlow(emptyList<PageItem>())

    val pageItems = _pageItems.asStateFlow()

    private var moveGridItemJob: Job? = null

    private val _foldersDataById = MutableStateFlow(ArrayDeque<FolderDataById>())

    val gridItemsCache = getGridItemsCacheUseCase().stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5_000),
        initialValue = GridItemCache(
            gridItemsCacheByPage = emptyMap(),
            dockGridItemsCache = emptyMap(),
            folderGridItemsCacheByPage = emptyMap(),
        ),
    )

    private val _pinGridItem = MutableStateFlow<GridItem?>(null)

    val pinGridItem = _pinGridItem.asStateFlow()

    val eblanShortcutInfosGroup = getEblanShortcutInfosUseCase().stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5_000),
        initialValue = emptyMap(),
    )

    val eblanAppWidgetProviderInfosGroup =
        eblanAppWidgetProviderInfoRepository.eblanAppWidgetProviderInfos.map { eblanAppWidgetProviderInfos ->
            eblanAppWidgetProviderInfos.groupBy { eblanAppWidgetProviderInfo ->
                eblanAppWidgetProviderInfo.packageName
            }
        }.stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5_000),
            initialValue = emptyMap(),
        )

    val iconPackFilePaths = getIconPackFilePathsUseCase().stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5_000),
        initialValue = emptyMap(),
    )

    private val _eblanApplicationInfoLabel = MutableStateFlow("")

    private val _eblanApplicationInfoTagIds = MutableStateFlow<List<Long>?>(null)

    val getEblanApplicationInfosByLabel = getEblanApplicationInfosByLabelUseCase(
        labelFlow = _eblanApplicationInfoLabel,
        eblanApplicationInfoTagIdsFlow = _eblanApplicationInfoTagIds,
    ).stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5_000),
        initialValue = GetEblanApplicationInfosByLabel(
            eblanApplicationInfos = emptyMap(),
            privateEblanUser = null,
            privateEblanApplicationInfos = emptyList(),
        ),
    )

    private val _eblanAppWidgetProviderInfoLabel = MutableStateFlow("")

    val eblanAppWidgetProviderInfos =
        getEblanAppWidgetProviderInfosByLabelUseCase(labelFlow = _eblanAppWidgetProviderInfoLabel).stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5_000),
            initialValue = emptyMap(),
        )

    private val _eblanShortcutConfigLabel = MutableStateFlow("")

    val eblanShortcutConfigs =
        getEblanShortcutConfigsByLabelUseCase(labelFlow = _eblanShortcutConfigLabel).stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5_000),
            initialValue = emptyMap(),
        )

    val eblanApplicationInfoTags =
        eblanApplicationInfoTagRepository.eblanApplicationInfoTags.stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5_000),
            initialValue = emptyList(),
        )

    private var syncDataJob: Job? = null

    private var launcherAppsEventJob: Job? = null

    fun moveGridItem(
        movingGridItem: GridItem,
        x: Int,
        y: Int,
        columns: Int,
        rows: Int,
        gridWidth: Int,
        gridHeight: Int,
        lockMovement: Boolean,
    ) {
        moveGridItemJob?.cancel()

        moveGridItemJob = viewModelScope.launch {
            _moveGridItemResult.update {
                moveGridItemUseCase(
                    movingGridItem = movingGridItem,
                    x = x,
                    y = y,
                    columns = columns,
                    rows = rows,
                    gridWidth = gridWidth,
                    gridHeight = gridHeight,
                    lockMovement = lockMovement,
                )
            }
        }
    }

    fun resizeGridItem(
        resizingGridItem: GridItem,
        columns: Int,
        rows: Int,
        lockMovement: Boolean,
    ) {
        moveGridItemJob?.cancel()

        moveGridItemJob = viewModelScope.launch {
            _moveGridItemResult.update {
                resizeGridItemUseCase(
                    resizingGridItem = resizingGridItem,
                    columns = columns,
                    rows = rows,
                    lockMovement = lockMovement,
                )
            }
        }
    }

    fun moveFolderGridItem(
        movingGridItem: GridItem,
        x: Int,
        y: Int,
        columns: Int,
        rows: Int,
        gridWidth: Int,
        gridHeight: Int,
        lockMovement: Boolean,
    ) {
        moveGridItemJob?.cancel()

        moveGridItemJob = viewModelScope.launch {
            _moveGridItemResult.update {
                moveFolderGridItemUseCase(
                    movingGridItem = movingGridItem,
                    x = x,
                    y = y,
                    columns = columns,
                    rows = rows,
                    gridWidth = gridWidth,
                    gridHeight = gridHeight,
                    lockMovement = lockMovement,
                )
            }
        }
    }

    fun resizeFolderGridItem(
        resizingGridItem: GridItem,
        columns: Int,
        rows: Int,
        lockMovement: Boolean,
    ) {
        moveGridItemJob?.cancel()

        moveGridItemJob = viewModelScope.launch {
            _moveGridItemResult.update {
                resizeFolderGridItemUseCase(
                    resizingGridItem = resizingGridItem,
                    columns = columns,
                    rows = rows,
                    lockMovement = lockMovement,
                )
            }
        }
    }

    fun showGridCache(
        screen: Screen,
        gridItems: List<GridItem>,
    ) {
        viewModelScope.launch {
            gridCacheRepository.insertGridItems(gridItems = gridItems)

            delay(defaultDelay)

            _screen.update {
                screen
            }
        }
    }

    fun showFolderGridCache(
        screen: Screen,
        gridItems: List<GridItem>,
    ) {
        viewModelScope.launch {
            folderGridCacheRepository.insertGridItems(gridItems = gridItems)

            delay(defaultDelay)

            _screen.update {
                screen
            }
        }
    }

    fun showPageCache(
        gridItems: List<GridItem>,
        associate: Associate,
    ) {
        viewModelScope.launch {
            _screen.update {
                Screen.Loading
            }

            _pageItems.update {
                cachePageItemsUseCase(
                    gridItems = gridItems,
                    associate = associate,
                )
            }

            delay(defaultDelay)

            _screen.update {
                Screen.EditPage
            }
        }
    }

    fun saveEditPage(
        id: Int,
        pageItems: List<PageItem>,
        pageItemsToDelete: List<PageItem>,
        associate: Associate,
    ) {
        viewModelScope.launch {
            _screen.update {
                Screen.Loading
            }

            updatePageItemsUseCase(
                id = id,
                pageItems = pageItems,
                pageItemsToDelete = pageItemsToDelete,
                associate = associate,
            )

            delay(defaultDelay)

            _screen.update {
                Screen.Pager
            }
        }
    }

    fun updateScreen(screen: Screen) {
        _screen.update {
            screen
        }
    }

    fun resetGridCacheAfterResize(resizingGridItem: GridItem) {
        viewModelScope.launch {
            moveGridItemJob?.cancelAndJoin()

            updateGridItemsAfterResizeUseCase(resizingGridItem = resizingGridItem)

            delay(defaultDelay)

            _screen.update {
                Screen.Pager
            }

            _moveGridItemResult.update {
                null
            }
        }
    }

    fun resetGridCacheAfterMove(moveGridItemResult: MoveGridItemResult) {
        viewModelScope.launch {
            moveGridItemJob?.cancelAndJoin()

            updateGridItemsAfterMoveUseCase(moveGridItemResult = moveGridItemResult)

            delay(defaultDelay)

            _screen.update {
                Screen.Pager
            }

            _moveGridItemResult.update {
                null
            }
        }
    }

    fun resetGridCacheAfterMoveWidgetGridItem(moveGridItemResult: MoveGridItemResult) {
        viewModelScope.launch {
            moveGridItemJob?.cancelAndJoin()

            gridCacheRepository.updateGridItemData(
                id = moveGridItemResult.movingGridItem.id,
                data = moveGridItemResult.movingGridItem.data,
            )

            updateGridItemsAfterMoveUseCase(moveGridItemResult = moveGridItemResult)

            delay(defaultDelay)

            _screen.update {
                Screen.Pager
            }

            _moveGridItemResult.update {
                null
            }
        }
    }

    fun resetGridCacheAfterMoveFolder() {
        viewModelScope.launch {
            moveGridItemJob?.cancelAndJoin()

            val lastFolderId = _foldersDataById.value.last().folderId

            gridRepository.updateGridItems(gridItems = folderGridCacheRepository.gridItemsCache.first())

            getFolderDataByIdUseCase(folderId = lastFolderId)?.let { folderDataById ->
                _foldersDataById.update { currentFolders ->
                    currentFolders.apply {
                        val index = currentFolders.indexOfFirst { it.folderId == lastFolderId }

                        currentFolders[index] = folderDataById
                    }
                }

                delay(defaultDelay)

                _screen.update {
                    Screen.Folder(folderDataById = folderDataById)
                }
            }

            _moveGridItemResult.update {
                null
            }
        }
    }

    fun cancelGridCache() {
        viewModelScope.launch {
            moveGridItemJob?.cancelAndJoin()

            delay(defaultDelay)

            _screen.update {
                Screen.Pager
            }

            _moveGridItemResult.update {
                null
            }
        }
    }

    fun cancelFolderGridCache() {
        viewModelScope.launch {
            moveGridItemJob?.cancelAndJoin()

            val lastFolderId = _foldersDataById.value.last().folderId

            getFolderDataByIdUseCase(folderId = lastFolderId)?.let { folderDataById ->
                _foldersDataById.update { currentFolders ->
                    currentFolders.apply {
                        val index = currentFolders.indexOfFirst { it.folderId == lastFolderId }

                        currentFolders[index] = folderDataById
                    }
                }

                delay(defaultDelay)

                _screen.update {
                    Screen.Folder(folderDataById = folderDataById)
                }
            }

            _moveGridItemResult.update {
                null
            }
        }
    }

    fun updateShortcutConfigGridItemDataCache(
        byteArray: ByteArray?,
        moveGridItemResult: MoveGridItemResult,
        gridItem: GridItem,
        data: GridItemData.ShortcutConfig,
    ) {
        viewModelScope.launch {
            val shortcutIntentIcon = byteArray?.let { currentByteArray ->
                fileManager.updateAndGetFilePath(
                    fileManager.getFilesDirectory(FileManager.SHORTCUT_INTENT_ICONS_DIR),
                    gridItem.id,
                    currentByteArray,
                )
            }

            gridCacheRepository.updateGridItemData(
                id = gridItem.id,
                data = data.copy(shortcutIntentIcon = shortcutIntentIcon),
            )

            resetGridCacheAfterMove(moveGridItemResult = moveGridItemResult)
        }
    }

    fun deleteGridItemCache(gridItem: GridItem) {
        viewModelScope.launch {
            gridCacheRepository.deleteGridItem(gridItem = gridItem)

            gridRepository.updateGridItems(gridItems = gridCacheRepository.gridItemsCache.first())

            delay(defaultDelay)

            _screen.update {
                Screen.Pager
            }
        }
    }

    fun deleteWidgetGridItemCache(
        gridItem: GridItem,
        appWidgetId: Int,
    ) {
        viewModelScope.launch {
            appWidgetHostWrapper.deleteAppWidgetId(appWidgetId = appWidgetId)

            gridCacheRepository.deleteGridItem(gridItem = gridItem)

            gridRepository.updateGridItems(gridItems = gridCacheRepository.gridItemsCache.first())

            delay(defaultDelay)

            _screen.update {
                Screen.Pager
            }
        }
    }

    fun showFolder(folderId: String) {
        viewModelScope.launch {
            getFolderDataByIdUseCase(folderId = folderId)?.let { folderDataById ->
                _foldersDataById.update { currentFolders ->
                    currentFolders.apply {
                        clear()

                        add(folderDataById)
                    }
                }

                _screen.update {
                    Screen.Folder(folderDataById = folderDataById)
                }
            }
        }
    }

    fun addFolder(folderId: String) {
        viewModelScope.launch {
            getFolderDataByIdUseCase(folderId = folderId)?.let { folderDataById ->
                _foldersDataById.update { currentFolders ->
                    currentFolders.apply {
                        add(folderDataById)
                    }
                }

                _screen.update {
                    Screen.Folder(folderDataById = folderDataById)
                }
            }
        }
    }

    fun removeLastFolder() {
        _foldersDataById.update { currentFolders ->
            if (currentFolders.isNotEmpty()) {
                currentFolders.apply {
                    removeLast()
                }
            } else {
                ArrayDeque()
            }
        }

        _screen.update {
            if (_foldersDataById.value.isNotEmpty()) {
                Screen.Folder(folderDataById = _foldersDataById.value.last())
            } else {
                Screen.Pager
            }
        }
    }

    fun getEblanApplicationInfosByLabel(label: String) {
        _eblanApplicationInfoLabel.update {
            label
        }
    }

    fun getEblanAppWidgetProviderInfosByLabel(label: String) {
        _eblanAppWidgetProviderInfoLabel.update {
            label
        }
    }

    fun getEblanShortcutConfigsByLabel(label: String) {
        _eblanShortcutConfigLabel.update {
            label
        }
    }

    fun deleteGridItem(gridItem: GridItem) {
        viewModelScope.launch {
            gridRepository.deleteGridItem(gridItem = gridItem)
        }
    }

    fun getPinGridItem(pinItemRequestType: PinItemRequestType) {
        viewModelScope.launch {
            _pinGridItem.update {
                getPinGridItemUseCase(pinItemRequestType = pinItemRequestType)
            }
        }
    }

    fun resetPinGridItem() {
        _pinGridItem.update {
            null
        }
    }

    fun updateShortcutConfigIntoShortcutInfoGridItem(
        moveGridItemResult: MoveGridItemResult,
        pinItemRequestType: PinItemRequestType.ShortcutInfo,
    ) {
        viewModelScope.launch {
            gridCacheRepository.deleteGridItem(gridItem = moveGridItemResult.movingGridItem)

            val eblanApplicationInfoIcon =
                packageManagerWrapper.getComponentName(packageName = pinItemRequestType.packageName)
                    ?.let { componentName ->
                        val directory = fileManager.getFilesDirectory(FileManager.ICONS_DIR)

                        val file = File(
                            directory,
                            componentName.hashCode().toString(),
                        )

                        file.absolutePath
                    }

            val data = ShortcutInfo(
                shortcutId = pinItemRequestType.shortcutId,
                packageName = pinItemRequestType.packageName,
                serialNumber = pinItemRequestType.serialNumber,
                shortLabel = pinItemRequestType.shortLabel,
                longLabel = pinItemRequestType.longLabel,
                icon = pinItemRequestType.icon,
                isEnabled = pinItemRequestType.isEnabled,
                eblanApplicationInfoIcon = eblanApplicationInfoIcon,
                customIcon = null,
                customShortLabel = null,
            )

            gridCacheRepository.insertGridItem(
                gridItem = moveGridItemResult.movingGridItem.copy(
                    data = data,
                ),
            )

            resetGridCacheAfterMove(moveGridItemResult = moveGridItemResult)
        }
    }

    fun moveGridItemOutsideFolder(
        folderId: String,
        movingGridItem: GridItem,
        gridItems: List<GridItem>,
        screen: Screen,
    ) {
        viewModelScope.launch {
            moveGridItemOutsideFolderUseCase(
                folderId = folderId,
                movingGridItem = movingGridItem,
                gridItems = gridItems,
            )

            delay(defaultDelay)

            _screen.update {
                screen
            }
        }
    }

    fun showFolderWhenDragging(folderId: String) {
        viewModelScope.launch {
            getFolderDataByIdUseCase(folderId = folderId)?.let { folderDataById ->
                _foldersDataById.update { currentFolders ->
                    currentFolders.apply {
                        clear()

                        add(folderDataById)
                    }
                }

                showFolderGridCache(
                    screen = Screen.FolderDrag(folderDataById = folderDataById),
                    gridItems = folderDataById.gridItems,
                )
            }
        }
    }

    fun getEblanApplicationInfosByTagId(tagIds: List<Long>) {
        _eblanApplicationInfoTagIds.update {
            tagIds
        }
    }

    fun startSyncData() {
        syncDataJob = viewModelScope.launch {
            syncDataUseCase()
        }

        launcherAppsEventJob = viewModelScope.launch {
            launcherAppsWrapper.launcherAppsEvent.collect { launcherAppsEvent ->
                when (launcherAppsEvent) {
                    is LauncherAppsEvent.PackageAdded -> {
                        addPackageUseCase(
                            serialNumber = launcherAppsEvent.serialNumber,
                            packageName = launcherAppsEvent.packageName,
                        )
                    }

                    is LauncherAppsEvent.PackageChanged -> {
                        changePackageUseCase(
                            serialNumber = launcherAppsEvent.serialNumber,
                            packageName = launcherAppsEvent.packageName,
                        )
                    }

                    is LauncherAppsEvent.PackageRemoved -> {
                        removePackageUseCase(
                            serialNumber = launcherAppsEvent.serialNumber,
                            packageName = launcherAppsEvent.packageName,
                        )
                    }

                    is LauncherAppsEvent.ShortcutsChanged -> {
                        changeShortcutsUseCase(
                            launcherAppsShortcutInfos = launcherAppsEvent.launcherAppsShortcutInfos,
                        )
                    }
                }
            }
        }
    }

    fun stopSyncData() {
        syncDataJob?.cancel()

        launcherAppsEventJob?.cancel()

        syncDataJob = null

        launcherAppsEventJob = null
    }

    fun resetGridCacheAfterResizeFolder(resizingGridItem: GridItem) {
        viewModelScope.launch {
            moveGridItemJob?.cancelAndJoin()

            val lastFolderId = _foldersDataById.value.last().folderId

            updateFolderGridItemsAfterResizeUseCase(resizingGridItem = resizingGridItem)

            getFolderDataByIdUseCase(folderId = lastFolderId)?.let { folderDataById ->
                _foldersDataById.update { currentFolders ->
                    currentFolders.apply {
                        val index = currentFolders.indexOfFirst { it.folderId == lastFolderId }

                        currentFolders[index] = folderDataById
                    }
                }

                delay(defaultDelay)

                _screen.update {
                    Screen.Folder(folderDataById = folderDataById)
                }
            }

            _moveGridItemResult.update {
                null
            }
        }
    }

    fun updateAppDrawerSettings(appDrawerSettings: AppDrawerSettings) {
        viewModelScope.launch {
            userDataRepository.updateAppDrawerSettings(appDrawerSettings = appDrawerSettings)
        }
    }

    fun updateEblanApplicationInfos(eblanApplicationInfos: List<EblanApplicationInfo>) {
        viewModelScope.launch {
            eblanApplicationInfoRepository.updateEblanApplicationInfos(eblanApplicationInfos = eblanApplicationInfos)
        }
    }
}
